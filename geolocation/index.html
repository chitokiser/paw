<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GeoHunt 게임</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 800px; }
    #locateBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #888;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>강아지 사냥 게임</h2>
  <div id="map"></div>
  <button id="locateBtn">현재 위치</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    /* ---------------------------
       1. Firebase 초기화
    --------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCoeMQt7UZzNHFt22bnGv_-6g15BnwCEBA",
      authDomain: "puppi-d67a1.firebaseapp.com",
      projectId: "puppi-d67a1",
      storageBucket: "puppi-d67a1.appspot.com",
      messagingSenderId: "552900371836",
      appId: "1:552900371836:web:88fb6c6a7d3ca3c84530f9",
      measurementId: "G-9TZ81RW0PL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ---------------------------
       2. 컨트랙트 정보
    --------------------------- */
    const CONTRACT_ADDRESS = "YOUR_CONTRACT_ADDRESS"; // 실제 배포 주소 입력
    const CONTRACT_ABI = [
      "function hunt(uint256 mid, uint256 pass) external"
    ];

    let provider, signer, contract;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("Metamask 지갑이 필요합니다!");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    }

    /* ---------------------------
       3. 지도 초기화
    --------------------------- */
    const map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    /* ---------------------------
       4. 전역 변수
    --------------------------- */
    let userLat = null;
    let userLon = null;
    let userCircle = null;

    /* ---------------------------
       5. 거리 계산 함수
    --------------------------- */
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = (deg) => deg * Math.PI / 180;
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const Δφ = toRad(lat2 - lat1);
      const Δλ = toRad(lon2 - lon1);
      const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    /* ---------------------------
       6. Firebase에서 몬스터 불러오기
    --------------------------- */
    const monsters = [];
    async function loadMonsters() {
      const querySnapshot = await getDocs(collection(db, "monsters"));
      querySnapshot.forEach(doc => {
        const data = doc.data();
        data.marker = null; // 마커 참조 저장
        monsters.push(data);
      });
    }

    /* ---------------------------
       7. 위치 추적 및 사냥 로직
    --------------------------- */
    async function initGame() {
      await connectWallet();
      await loadMonsters();

      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;

        // 내 위치 마커 항상 표시 (최초 1회 생성 후 위치 갱신)
        if (!map.userMarker) {
          map.userMarker = L.marker([userLat, userLon]).addTo(map).bindPopup("내 위치");
          map.setView([userLat, userLon], 17);
        } else {
          map.userMarker.setLatLng([userLat, userLon]);
        }

        // 5m 범위 원 항상 갱신
        if (userCircle) map.removeLayer(userCircle);
        userCircle = L.circle([userLat, userLon], { radius: 5, color: 'blue', fillOpacity: 0.1 }).addTo(map);

        // 몬스터 거리 체크
        monsters.forEach(monster => {
          const distance = getDistance(userLat, userLon, monster.lat, monster.lon);

          if (distance <= 5) {
            if (!monster.marker) {
              const icon = L.icon({
                iconUrl: monster.imagesURL,
                iconSize: [40, 40]
              });
              monster.marker = L.marker([monster.lat, monster.lon], { icon }).addTo(map);

              monster.marker.on('click', async () => {
                try {
                  const tx = await contract.hunt(monster.mid, monster.pass);
                  await tx.wait();
                  alert(`사냥 성공! mid: ${monster.mid}`);
                } catch (err) {
                  console.error("hunt 호출 실패:", err);
                  alert("사냥 실패: " + err.message);
                }
              });
            }
          } else {
            if (monster.marker) {
              map.removeLayer(monster.marker);
              monster.marker = null;
            }
          }
        });
      }, err => {
        console.error("위치 추적 실패:", err);
        alert("위치 정보를 가져올 수 없습니다. 브라우저 위치 권한을 확인하세요.");
      }, { enableHighAccuracy: true });
    }

    /* ---------------------------
       8. 현재 위치 버튼
    --------------------------- */
    document.getElementById("locateBtn").addEventListener("click", () => {
      if (userLat && userLon) {
        map.setView([userLat, userLon], 17);
      } else {
        alert("현재 위치 정보를 불러오는 중입니다.");
      }
    });

    initGame();
  </script>
</body>
</html>
