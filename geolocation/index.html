<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GeoHunt ê²Œì„</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    #locateBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: 1px solid #888;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #locateBtn:hover {
      background: #f1f1f1;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="locateBtn">ğŸ“</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- ethers.js CDN ë³€ê²½ (jsDelivr ì•ˆì •íŒ) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    (async () => {
      // Firebase ëª¨ë“ˆ ë¡œë“œ
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js");
      const { getFirestore, collection, getDocs, doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js");

      /* ---------------------------
         Firebase ì´ˆê¸°í™”
      --------------------------- */
      const firebaseConfig = {
        apiKey: "AIzaSyCoeMQt7UZzNHFt22bnGv_-6g15BnwCEBA",
        authDomain: "puppi-d67a1.firebaseapp.com",
        projectId: "puppi-d67a1",
        storageBucket: "puppi-d67a1.appspot.com",
        messagingSenderId: "552900371836",
        appId: "1:552900371836:web:88fb6c6a7d3ca3c84530f9",
        measurementId: "G-9TZ81RW0PL"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      /* ---------------------------
         ì»¨íŠ¸ë™íŠ¸ ì •ë³´
      --------------------------- */
      const CONTRACT_ADDRESS = "0xD36b5769b3eea86ecB352E8DF200e1B09462ffc5";
      const CONTRACT_ABI = ["function hunt(uint256 mid, uint256 pass) external"];

      let provider, signer, contract;
      async function connectWallet() {
        if (!window.ethereum) {
          alert("Metamask ë˜ëŠ” Rabby ì§€ê°‘ì´ í•„ìš”í•©ë‹ˆë‹¤!");
          return;
        }
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      }

      /* ---------------------------
         ì§€ë„ ì´ˆê¸°í™”
      --------------------------- */
      const map = L.map('map').setView([37.5665, 126.9780], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      let userLat = null;
      let userLon = null;
      let userCircle = null;

      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = (deg) => deg * Math.PI / 180;
        const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
        const Î”Ï† = toRad(lat2 - lat1);
        const Î”Î» = toRad(lon2 - lon1);
        const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      const monsters = [];
      async function loadMonsters() {
        const querySnapshot = await getDocs(collection(db, "monsters"));
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          data.id = docSnap.id;
          data.marker = null;
          monsters.push(data);
        });
      }

      function updateUserMarker(lat, lon) {
        const puppyIcon = L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png',
          iconSize: [160, 160],   // 2ë°° í™•ëŒ€
          iconAnchor: [80, 80],
          popupAnchor: [0, -80]
        });

        if (!map.userMarker) {
          map.userMarker = L.marker([lat, lon], { icon: puppyIcon })
            .addTo(map)
            .bindPopup("ë‚´ ê°•ì•„ì§€ ìœ„ì¹˜");
          map.setView([lat, lon], 17);
        } else {
          map.userMarker.setLatLng([lat, lon]);
        }

        if (userCircle) map.removeLayer(userCircle);
        userCircle = L.circle([lat, lon], { radius: 50, color: 'blue', fillOpacity: 0.2 }).addTo(map);
      }

      function fallbackLocation() {
        userLat = 37.5665;
        userLon = 126.9780;
        updateUserMarker(userLat, userLon);
        alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸)ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.");
      }

      async function checkPermission() {
        if (navigator.permissions) {
          try {
            const status = await navigator.permissions.query({ name: 'geolocation' });
            console.log("ê¶Œí•œ ìƒíƒœ:", status.state);
            if (status.state === 'denied') {
              alert("ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì • â†’ ì‚¬ì´íŠ¸ ê¶Œí•œì—ì„œ ìœ„ì¹˜ í—ˆìš©ìœ¼ë¡œ ë³€ê²½ í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
            } else if (status.state === 'prompt') {
              alert("ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ íŒì—…ì´ ë‚˜íƒ€ë‚˜ë©´ ë°˜ë“œì‹œ 'í—ˆìš©'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
            }
          } catch (e) {
            console.warn("ê¶Œí•œ ìƒíƒœ í™•ì¸ ë¶ˆê°€:", e);
          }
        }
      }

      function requestLocation() {
        if (!navigator.geolocation) {
          alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
          userLat = pos.coords.latitude;
          userLon = pos.coords.longitude;
          updateUserMarker(userLat, userLon);
        }, err => {
          console.warn("í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", err);
          fallbackLocation();
        });

        navigator.geolocation.watchPosition(pos => {
          userLat = pos.coords.latitude;
          userLon = pos.coords.longitude;
          updateUserMarker(userLat, userLon);

          monsters.forEach(monster => {
            const distance = getDistance(userLat, userLon, monster.lat, monster.lon);

            if (distance <= 50) {
              if (!monster.marker) {
                const icon = L.icon({
                  iconUrl: monster.imagesURL,
                  iconSize: [160, 160],   // 2ë°° í™•ëŒ€
                  iconAnchor: [80, 80]
                });
                monster.marker = L.marker([monster.lat, monster.lon], { icon }).addTo(map);

                monster.marker.on('click', async () => {
                  try {
                    const tx = await contract.hunt(monster.mid, monster.pass);
                    await tx.wait();

                    await deleteDoc(doc(db, "monsters", monster.id));
                    map.removeLayer(monster.marker);
                    monster.marker = null;

                    alert(`ì‚¬ëƒ¥ ì„±ê³µ! mid: ${monster.mid}`);
                  } catch (err) {
                    console.error("hunt í˜¸ì¶œ ì‹¤íŒ¨:", err);
                    alert("ì‚¬ëƒ¥ ì‹¤íŒ¨: " + err.message);
                  }
                });
              }
            } else {
              if (monster.marker) {
                map.removeLayer(monster.marker);
                monster.marker = null;
              }
            }
          });
        }, err => {
          console.warn("ìœ„ì¹˜ ì¶”ì  ì‹¤íŒ¨:", err);
          fallbackLocation();
        }, { enableHighAccuracy: true });
      }

      document.getElementById("locateBtn").addEventListener("click", () => {
        if (userLat && userLon) {
          map.setView([userLat, userLon], 17);
        } else {
          alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.");
        }
      });

      // ì´ˆê¸° ì‹¤í–‰
      await connectWallet();
      await loadMonsters();
      await checkPermission();
      requestLocation();
    })();
  </script>
</body>
</html>
