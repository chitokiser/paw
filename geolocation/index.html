<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GeoHunt Í≤åÏûÑ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    #locateBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: 1px solid #888;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #locateBtn:hover {
      background: #f1f1f1;
    }
    @media (max-width: 600px) {
      #locateBtn {
        width: 48px;
        height: 48px;
        font-size: 20px;
        bottom: 15px;
        right: 15px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="locateBtn">üìç</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    /* ---------------------------
       Firebase Ï¥àÍ∏∞Ìôî
    --------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCoeMQt7UZzNHFt22bnGv_-6g15BnwCEBA",
      authDomain: "puppi-d67a1.firebaseapp.com",
      projectId: "puppi-d67a1",
      storageBucket: "puppi-d67a1.appspot.com",
      messagingSenderId: "552900371836",
      appId: "1:552900371836:web:88fb6c6a7d3ca3c84530f9",
      measurementId: "G-9TZ81RW0PL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ---------------------------
       Ïª®Ìä∏ÎûôÌä∏ Ï†ïÎ≥¥
    --------------------------- */
    const CONTRACT_ADDRESS = "0xD36b5769b3eea86ecB352E8DF200e1B09462ffc5"; // Ïã§Ï†ú Î∞∞Ìè¨ Ï£ºÏÜå
    const CONTRACT_ABI = [
      "function hunt(uint256 mid, uint256 pass) external"
    ];

    let provider, signer, contract;
    async function connectWallet() {
      if (!window.ethereum) {
        alert("Metamask ÎòêÎäî Rabby ÏßÄÍ∞ëÏù¥ ÌïÑÏöîÌï©ÎãàÎã§!");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    }

    /* ---------------------------
       ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
    --------------------------- */
    const map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userLat = null;
    let userLon = null;
    let userCircle = null;

    /* ---------------------------
       Í±∞Î¶¨ Í≥ÑÏÇ∞ Ìï®Ïàò
    --------------------------- */
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = (deg) => deg * Math.PI / 180;
      const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
      const ŒîœÜ = toRad(lat2 - lat1);
      const ŒîŒª = toRad(lon2 - lon1);
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    /* ---------------------------
       FirebaseÏóêÏÑú Î™¨Ïä§ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
    --------------------------- */
    const monsters = [];
    async function loadMonsters() {
      const querySnapshot = await getDocs(collection(db, "monsters"));
      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        data.id = docSnap.id; // Firebase Î¨∏ÏÑú ID Ï†ÄÏû•
        data.marker = null;
        monsters.push(data);
      });
    }

    /* ---------------------------
       ÎÇ¥ ÏúÑÏπò ÎßàÏª§ Í∞±Ïã† (Í∞ïÏïÑÏßÄ ÏïÑÏù¥ÏΩò)
    --------------------------- */
    function updateUserMarker(lat, lon) {
      const puppyIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png',
        iconSize: [80, 80],      // 2Î∞∞ ÌôïÎåÄ
        iconAnchor: [40, 40],
        popupAnchor: [0, -40]
      });

      if (!map.userMarker) {
        map.userMarker = L.marker([lat, lon], { icon: puppyIcon })
          .addTo(map)
          .bindPopup("ÎÇ¥ Í∞ïÏïÑÏßÄ ÏúÑÏπò");
        map.setView([lat, lon], 17);
      } else {
        map.userMarker.setLatLng([lat, lon]);
      }

      // 50m Ïõê Í∞±Ïã†
      if (userCircle) map.removeLayer(userCircle);
      userCircle = L.circle([lat, lon], { radius: 50, color: 'blue', fillOpacity: 0.2 }).addTo(map);
    }

    /* ---------------------------
       fallback ÏúÑÏπò Ï≤òÎ¶¨
    --------------------------- */
    function fallbackLocation() {
      userLat = 37.5665;
      userLon = 126.9780;
      updateUserMarker(userLat, userLon);
      alert("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏñ¥ Í∏∞Î≥∏ ÏúÑÏπò(ÏÑúÏö∏)Î°ú ÌëúÏãúÌï©ÎãàÎã§.");
    }

    /* ---------------------------
       Í∂åÌïú ÏÉÅÌÉú ÌôïÏù∏ Î∞è ÏïàÎÇ¥
    --------------------------- */
    async function checkPermission() {
      if (navigator.permissions) {
        const status = await navigator.permissions.query({ name: 'geolocation' });
        console.log("Í∂åÌïú ÏÉÅÌÉú:", status.state);
        if (status.state === 'denied') {
          alert("ÏúÑÏπò Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÌóàÏö© ÌõÑ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏÑ∏Ïöî.");
        }
      }
    }

    /* ---------------------------
       ÏúÑÏπò Ï∂îÏ†Å ÏãúÏûë
    --------------------------- */
    function requestLocation() {
      if (!navigator.geolocation) {
        alert("Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
        return;
      }

      // ÏµúÏ¥à ÏúÑÏπò Ìïú Î≤à Í∞ÄÏ†∏Ïò§Í∏∞
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        updateUserMarker(userLat, userLon);
      }, err => {
        console.warn("ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:", err);
        fallbackLocation();
      });

      // ÏßÄÏÜç Ï∂îÏ†Å
      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        updateUserMarker(userLat, userLon);

        // Î™¨Ïä§ÌÑ∞ Í±∞Î¶¨ Ï≤¥ÌÅ¨ (50m Î∞òÍ≤Ω)
        monsters.forEach(monster => {
          const distance = getDistance(userLat, userLon, monster.lat, monster.lon);

          if (distance <= 50) { // 50m Î∞òÍ≤Ω
            if (!monster.marker) {
              const icon = L.icon({
                iconUrl: monster.imagesURL,
                iconSize: [80, 80],   // 2Î∞∞ ÌôïÎåÄ
                iconAnchor: [40, 40]
              });
              monster.marker = L.marker([monster.lat, monster.lon], { icon }).addTo(map);

              // ÏÇ¨ÎÉ• ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
              monster.marker.on('click', async () => {
                try {
                  const tx = await contract.hunt(monster.mid, monster.pass);
                  await tx.wait();

                  // FirebaseÏóêÏÑú Ï†úÍ±∞ + ÏßÄÎèÑÏóêÏÑú ÎßàÏª§ Ï†úÍ±∞
                  await deleteDoc(doc(db, "monsters", monster.id));
                  map.removeLayer(monster.marker);
                  monster.marker = null;

                  alert(`ÏÇ¨ÎÉ• ÏÑ±Í≥µ! mid: ${monster.mid}`);
                } catch (err) {
                  console.error("hunt Ìò∏Ï∂ú Ïã§Ìå®:", err);
                  alert("ÏÇ¨ÎÉ• Ïã§Ìå®: " + err.message);
                }
              });
            }
          } else {
            if (monster.marker) {
              map.removeLayer(monster.marker);
              monster.marker = null;
            }
          }
        });
      }, err => {
        console.warn("ÏúÑÏπò Ï∂îÏ†Å Ïã§Ìå®:", err);
        fallbackLocation();
      }, { enableHighAccuracy: true });
    }

    /* ---------------------------
       ÌòÑÏû¨ ÏúÑÏπò Î≤ÑÌäº
    --------------------------- */
    document.getElementById("locateBtn").addEventListener("click", () => {
      if (userLat && userLon) {
        map.setView([userLat, userLon], 17);
      } else {
        alert("ÌòÑÏû¨ ÏúÑÏπò Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§.");
      }
    });

    /* ---------------------------
       Ï¥àÍ∏∞ Ïã§Ìñâ
    --------------------------- */
    (async () => {
      await connectWallet();
      await loadMonsters();
      await checkPermission();
      requestLocation();
    })();

  </script>
</body>
</html>
