<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GeoHunt 게임</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }

    /* 상단 토스트 메시지 */
    #eventToast {
      position: fixed;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      color: #fff;
      display: none;
      z-index: 2000;
      animation: fadeInOut 4s forwards;
    }
    #eventToast.lost { background: rgba(255,0,0,0.8); }
    #eventToast.reward { background: rgba(0,200,0,0.8); }
    #eventToast.bonus { background: rgba(0,100,255,0.8); }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      10%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }

    /* 최근 이벤트 리스트 */
    #eventLog {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 12px;
      border-radius: 8px;
      padding: 6px;
      z-index: 1500;
    }
    #eventLog ul { list-style: none; margin: 0; padding: 0; }
    #eventLog li { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
    #eventLog li:last-child { border-bottom: none; }

    /* 하단 버튼 */
    .bottom-controls {
      position: fixed;
      bottom: 15px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
    }
    .bottom-controls button {
      width: 60px; height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 24px;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #homeBtn {
      width: 100px;
      border-radius: 12px;
      font-size: 16px;
    }

    /* 사운드 토글 */
    #soundToggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 48px; height: 48px;
      font-size: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- 토스트 -->
  <div id="eventToast"></div>

  <!-- 최근 이벤트 로그 -->
  <div id="eventLog"><ul id="eventList"></ul></div>

  <!-- 하단 버튼 -->
  <div class="bottom-controls">
    <button id="compassBtn">🧭</button>
    <button id="homeBtn">Home</button>
    <button id="locateBtn">📍</button>
  </div>

  <!-- 사운드 토글 -->
  <button id="soundToggle">🔊</button>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- ethers.js (안정 CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    /* Firebase 설정 */
    const firebaseConfig = {
      apiKey: "AIzaSyCoeMQt7UZzNHFt22bnGv_-6g15BnwCEBA",
      authDomain: "puppi-d67a1.firebaseapp.com",
      projectId: "puppi-d67a1",
      storageBucket: "puppi-d67a1.appspot.com",
      messagingSenderId: "552900371836",
      appId: "1:552900371836:web:88fb6c6a7d3ca3c84530f9",
      measurementId: "G-9TZ81RW0PL"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* 컨트랙트 정보 */
    const CONTRACT_ADDRESS = "0xD36b5769b3eea86ecB352E8DF200e1B09462ffc5";
    const CONTRACT_ABI = ["function hunt(uint256 mid, uint256 pass) external"];

    let provider, signer, contract;
    async function connectWallet() {
      if (!window.ethereum) {
        alert("Metamask 또는 Rabby 지갑이 필요합니다!");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    }

    /* 지도 초기화 */
    const map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userLat = null;
    let userLon = null;
    let userCircle = null;

    /* 거리 계산 */
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const Δφ = toRad(lat2 - lat1);
      const Δλ = toRad(lon2 - lon1);
      const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    /* 이벤트 토스트 + 로그 */
    const eventToast = document.getElementById("eventToast");
    const eventList = document.getElementById("eventList");
    function showEvent(type, message) {
      // 토스트
      eventToast.className = type;
      eventToast.textContent = message;
      eventToast.style.display = "block";
      setTimeout(() => eventToast.style.display = "none", 4000);

      // 로그 (최근 3개)
      const li = document.createElement("li");
      li.textContent = message;
      eventList.insertBefore(li, eventList.firstChild);
      while (eventList.children.length > 3) {
        eventList.removeChild(eventList.lastChild);
      }

      // 사운드 효과
      if (soundOn) {
        const audio = new Audio(type === "lost"
          ? "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
          : "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
        audio.play();
      }
    }

    /* 몬스터 데이터 로드 */
    const monsters = [];
    async function loadMonsters() {
      const querySnapshot = await getDocs(collection(db, "monsters"));
      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        data.id = docSnap.id;
        data.marker = null;
        monsters.push(data);
      });
    }

    /* 내 위치 아이콘 갱신 */
    function updateUserMarker(lat, lon) {
      const puppyIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png',
        iconSize: [160, 160],
        iconAnchor: [80, 80],
        popupAnchor: [0, -80]
      });

      if (!map.userMarker) {
        map.userMarker = L.marker([lat, lon], { icon: puppyIcon }).addTo(map).bindPopup("내 강아지 위치");
        map.setView([lat, lon], 17);
      } else {
        map.userMarker.setLatLng([lat, lon]);
      }

      if (userCircle) map.removeLayer(userCircle);
      userCircle = L.circle([lat, lon], { radius: 50, color: 'blue', fillOpacity: 0.2 }).addTo(map);
    }

    /* 위치 실패 fallback */
    function fallbackLocation() {
      userLat = 37.5665;
      userLon = 126.9780;
      updateUserMarker(userLat, userLon);
      alert("위치 정보를 가져올 수 없어 기본 위치(서울)로 표시합니다.");
    }

    /* 위치 권한 체크 */
    async function checkPermission() {
      if (navigator.permissions) {
        const status = await navigator.permissions.query({ name: 'geolocation' });
        if (status.state === 'denied') {
          alert("위치 권한 거부됨. 브라우저 설정에서 허용 후 새로고침하세요.");
        }
      }
    }

    /* 위치 추적 */
    function requestLocation() {
      if (!navigator.geolocation) {
        alert("위치 서비스 미지원 브라우저");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        updateUserMarker(userLat, userLon);
      }, fallbackLocation);

      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        updateUserMarker(userLat, userLon);

        monsters.forEach(monster => {
          const distance = getDistance(userLat, userLon, monster.lat, monster.lon);

          if (distance <= 50) {
            if (!monster.marker) {
              const icon = L.icon({
                iconUrl: monster.imagesURL,
                iconSize: [160, 160],
                iconAnchor: [80, 80]
              });
              monster.marker = L.marker([monster.lat, monster.lon], { icon }).addTo(map);

              // 사냥 이벤트
              monster.marker.on('click', async () => {
                try {
                  const tx = await contract.hunt(monster.mid, monster.pass);
                  await tx.wait();

                  // 예시: Lost or Reward 랜덤 처리 (실제는 이벤트 리스너 필요)
                  if (Math.random() > 0.5) {
                    showEvent('lost', `Lost! my 2542 : enemy ${monster.power || 35000}`);
                  } else {
                    showEvent('reward', `보상 획득! +${monster.power || 100} GP`);
                  }

                  await deleteDoc(doc(db, "monsters", monster.id));
                  map.removeLayer(monster.marker);
                  monster.marker = null;

                } catch (err) {
                  showEvent('lost', "사냥 실패: " + err.message);
                }
              });
            }
          } else {
            if (monster.marker) {
              map.removeLayer(monster.marker);
              monster.marker = null;
            }
          }
        });
      }, fallbackLocation, { enableHighAccuracy: true });
    }

    /* 버튼 기능 */
    document.getElementById("locateBtn").addEventListener("click", () => {
      if (userLat && userLon) map.setView([userLat, userLon], 17);
    });
    document.getElementById("homeBtn").addEventListener("click", () => {
      window.location.href = "/"; // 메인 페이지로 이동
    });

    /* 사운드 토글 */
    let soundOn = true;
    document.getElementById("soundToggle").addEventListener("click", () => {
      soundOn = !soundOn;
      document.getElementById("soundToggle").textContent = soundOn ? "🔊" : "🔇";
    });

    /* 초기 실행 */
    (async () => {
      await connectWallet();
      await loadMonsters();
      await checkPermission();
      requestLocation();
    })();
  </script>
</body>
</html>
