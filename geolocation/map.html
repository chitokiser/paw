<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GeoHunt</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: 'Segoe UI', Roboto, sans-serif;
  background: #f2f3f5;
}
#map {
  height: 100vh;
  width: 100%;
  position: relative;
}
/* Toast 디자인 개선 */
#eventToast {
  position: fixed;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  padding: 16px 24px;
  border-radius: 8px;
  backdrop-filter: blur(8px);
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  font-size: 18px;
  display: none;
  z-index: 3000;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}
#eventToast.reward { background: rgba(40, 167, 69, 0.85); }
#eventToast.lost   { background: rgba(220, 53, 69, 0.85); }
#eventToast.bonus  { background: rgba(23, 162, 184, 0.85); }

/* 이벤트 로그 */
#eventLog {
  position: fixed;
  bottom: 160px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 40px);
  max-width: 480px;
  background: rgba(0,0,0,0.5);
  color: #fff;
  font-size: 16px;
  border-radius: 8px;
  padding: 12px;
  z-index: 2500;
  max-height: 200px;
  overflow-y: auto;
}
#eventLog ul { margin: 0; padding: 0; list-style: none; }
#eventLog li {
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}
#eventLog li:last-child { border-bottom: none; }

/* 하단 버튼 레이아웃 개선 */
.bottom-controls {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: grid;
  grid-template-columns: repeat(3, 64px);
  gap: 20px;
  z-index: 2000;
}
.bottom-controls button {
  width: 64px;
  height: 64px;
  border: none;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  font-size: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s;
}
.bottom-controls button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
#homeBtn {
  width: auto;
  padding: 0 16px;
  border-radius: 16px;
  font-size: 18px;
}
#soundToggle {
  position: fixed;
  top: 30px;
  right: 30px;
  width: 56px;
  height: 56px;
  border: none;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}
#soundToggle:hover { transform: scale(1.1); }
</style>
</head>
<body>
  <div id="map"></div>
  <div id="eventToast"></div>
  <div id="eventLog"><ul id="eventList"></ul></div>
  <div class="bottom-controls">
    <button id="compassBtn">🧭</button>
    <button id="homeBtn">Home</button>
    <button id="locateBtn">📍</button>
  </div>
  <button id="soundToggle">🔊</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyCoeMQt7UZzNHFt22bnGv_-6g15BnwCEBA",
  authDomain: "puppi-d67a1.firebaseapp.com",
  projectId: "puppi-d67a1",
  storageBucket: "puppi-d67a1.appspot.com",
  messagingSenderId: "552900371836",
  appId: "1:552900371836:web:88fb6c6a7d3ca3c84530f9",
  measurementId: "G-9TZ81RW0PL"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Contract 정보
const CONTRACT_ADDRESS = "0xE81E0976D6aa80c9C2C210cEA6106592feBEB220";
const CONTRACT_ABI = [
  "function hunt(uint256 mid,uint256 pass) external",
  "event RewardGiven(address indexed user,uint256 rewardAmount)",
  "event Lost(address indexed user,uint256 enemyPower,uint256 myPower)"
];
let provider, signer, contract;
async function connectWallet() {
  if (!window.ethereum) { alert("Metamask 필요"); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
}

// Sound effects - 로컬 파일 경로로 변경하세요
// Sound effects
const clickSound   = new Audio('../sounds/hit.mp3');
const successSound = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
const failureSound = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
const barkSound    = new Audio('../sounds/puppybark.mp3');
let soundOn = true;

async function initialize() {
  await connectWallet();
  // 지도 초기화
  const map = L.map('map',{ maxZoom:22 }).setView([41.6955932,44.8357820],19);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

  // 이벤트 토스트
  const eventToast = document.getElementById('eventToast');
  const eventList  = document.getElementById('eventList');
  let totalScore = 0;
  function showEvent(type,message,reward=0) {
    if(reward>0) totalScore+=reward;
    const msg = `${message} (Total: ${totalScore} GP)`;
    eventToast.className = type;
    eventToast.textContent = msg;
    eventToast.style.display = 'block';
    setTimeout(()=>eventToast.style.display='none',2000);
    const li = document.createElement('li'); li.textContent=msg;
    eventList.insertBefore(li,eventList.firstChild);
    while(eventList.children.length>12) eventList.removeChild(eventList.lastChild);
  }

  // 거리 계산
  function getDistance(a,b,c,d){const R=6371000,t=x=>x*Math.PI/180;const φ1=t(a),φ2=t(c),dφ=t(c-a),dλ=t(d-b);const A=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}

  // Load monsters
  const monsters=[];
  (await getDocs(collection(db,'monsters'))).forEach(doc=>{const d=doc.data();d.marker=null;monsters.push(d);});

    // Update user marker
  let userCircle, first = true;
  function updateUserMarker(lat, lon) {
    const icon = L.icon({ iconUrl: '../images/face.png', iconSize: [80, 80], iconAnchor: [16, 16] });
    if (!map.userMarker) {
      map.userMarker = L.marker([lat, lon], { icon })
        .addTo(map)
        .bindPopup('my puppy');
      // 클릭 시 짖는 소리 재생
      map.userMarker.on('click', () => {
        if (soundOn) {
          barkSound.play().catch(e => console.warn('Bark audio error:', e));
        }
      });
    } else {
      map.userMarker.setLatLng([lat, lon]);
    }
    if (first) {
      map.setView([lat, lon], 19);
      first = false;
    }
    if (userCircle) {
      map.removeLayer(userCircle);
    }
    userCircle = L.circle([lat, lon], { radius: 50, color: 'blue', fillOpacity: 0.2 }).addTo(map);
  }

  // Initial location

  if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>updateUserMarker(p.coords.latitude,p.coords.longitude));

  // Watch position & game logic
  navigator.geolocation.watchPosition(async p=>{
    const lat=p.coords.latitude, lon=p.coords.longitude;
    updateUserMarker(lat,lon);
    monsters.forEach(m=>{
      const dist=getDistance(lat,lon,m.lat,m.lon);
      if(dist<=20 && !m.marker){
        m.marker = L.marker([m.lat, m.lon], {
          icon: L.icon({
            iconUrl: m.imagesURL,
            iconSize: [80, 80],
            iconAnchor: [30, 30]
          })
        }).addTo(map);
        m.marker.on('click',async ()=>{
          if (soundOn) clickSound.play().catch(e => {/* ignore unsupported */});
          try{
            const tx=await contract.hunt(m.mid,m.pass); const rc=await tx.wait(); let reward=0;
            rc.events.forEach(e=>{ if(e.event==='RewardGiven') reward=parseInt(e.args.rewardAmount.toString(),10); });
            if(reward>0){ if (soundOn) successSound.play().catch(e => {/* ignore unsupported */}); showEvent('reward',`+${reward} GP`,reward); }
            else{ if (soundOn) failureSound.play().catch(e => {/* ignore unsupported */}); showEvent('lost','획득 실패',0);}            
            map.removeLayer(m.marker); m.marker=null;
          }catch(err){ if(soundOn) failureSound.play(); showEvent('lost','에러 발생',0); }
        });
      }
    });
  }, err => console.error(err), { enableHighAccuracy: true });

  // Controls
  document.getElementById('locateBtn').onclick=()=>navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],19));
  document.getElementById('homeBtn').onclick=()=>location.href='/';
  document.getElementById('soundToggle').onclick=()=>{soundOn=!soundOn;document.getElementById('soundToggle').textContent=soundOn?'🔊':'🔇';};
}
initialize();
  </script>
</body>
</html>
