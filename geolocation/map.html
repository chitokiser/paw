<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GeoHunt</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
html, body { margin:0; padding:0; height:100%; width:100%; font-family:Arial,sans-serif; }
#map { height:100vh; width:100%; }
#eventToast { position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:18px 30px; border-radius:14px; font-weight:bold; font-size:clamp(22px,4vw,32px); color:#fff; text-shadow:2px 2px 4px rgba(0,0,0,0.5); display:none; z-index:2000; animation:fadeInOut 2s forwards; }
#eventToast.lost { background:rgba(255,0,0,0.85); }
#eventToast.reward { background:rgba(0,200,0,0.85); }
#eventToast.bonus { background:rgba(0,100,255,0.85); }
@keyframes fadeInOut { 0%{opacity:0;transform:translateX(-50%) translateY(-20px);}10%,80%{opacity:1;transform:translateX(-50%) translateY(0);}100%{opacity:0;transform:translateX(-50%) translateY(-20px);} }
.bottom-controls { position:fixed; bottom:20px; width:100%; display:flex; justify-content:space-between; padding:0 25px; z-index:1000; }
.bottom-controls button { width:80px; height:80px; border:none; border-radius:50%; font-size:30px; background:#fff; box-shadow:0 3px 8px rgba(0,0,0,0.3); }
#homeBtn { width:120px; border-radius:14px; font-size:20px; font-weight:bold; }
#soundToggle { position:fixed; top:20px; right:20px; width:60px; height:60px; border:none; border-radius:50%; background:#fff; font-size:24px; box-shadow:0 3px 8px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="eventToast"></div>
  <div id="eventLog"><ul id="eventList"></ul></div>
  <div class="bottom-controls">
    <button id="compassBtn">üß≠</button>
    <button id="homeBtn">Home</button>
    <button id="locateBtn">üìç</button>
  </div>
  <button id="soundToggle">üîä</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

// Firebase ÏÑ§Ï†ï
const firebaseConfig = {
  apiKey: "AIzaSyCoeMQt7UZzNHFt22bnGv_-6g15BnwCEBA",
  authDomain: "puppi-d67a1.firebaseapp.com",
  projectId: "puppi-d67a1",
  storageBucket: "puppi-d67a1.appspot.com",
  messagingSenderId: "552900371836",
  appId: "1:552900371836:web:88fb6c6a7d3ca3c84530f9",
  measurementId: "G-9TZ81RW0PL"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Contract Ï†ïÎ≥¥
const CONTRACT_ADDRESS = "0xE81E0976D6aa80c9C2C210cEA6106592feBEB220";
const CONTRACT_ABI = [
  "function hunt(uint256 mid,uint256 pass) external",
  "event RewardGiven(address indexed user,uint256 rewardAmount)",
  "event Lost(address indexed user,uint256 enemyPower,uint256 myPower)"
];
let provider, signer, contract;
async function connectWallet() {
  if (!window.ethereum) { alert("Metamask ÌïÑÏöî"); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
}

// Sound effects
const clickSound   = new Audio('../sounds/hit.mp3');
const successSound = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
const failureSound = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
const barkSound    = new Audio('../sounds/puppybark.mp3');
let soundOn = true;

async function initialize() {
  await connectWallet();
  // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
  const map = L.map('map',{ maxZoom:22 }).setView([41.6955932,44.8357820],19);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

  // Ïù¥Î≤§Ìä∏ ÌÜ†Ïä§Ìä∏
  const eventToast = document.getElementById('eventToast');
  const eventList  = document.getElementById('eventList');
  let totalScore = 0;
  function showEvent(type,message,reward=0) {
    if(reward>0) totalScore+=reward;
    const msg = `${message} (Total: ${totalScore} GP)`;
    eventToast.className = type;
    eventToast.textContent = msg;
    eventToast.style.display = 'block';
    setTimeout(()=>eventToast.style.display='none',2000);
    const li = document.createElement('li'); li.textContent=msg;
    eventList.insertBefore(li,eventList.firstChild);
    while(eventList.children.length>12) eventList.removeChild(eventList.lastChild);
  }

  // Í±∞Î¶¨ Í≥ÑÏÇ∞
  function getDistance(a,b,c,d){const R=6371000,t=x=>x*Math.PI/180;const œÜ1=t(a),œÜ2=t(c),dœÜ=t(c-a),dŒª=t(d-b);const A=Math.sin(dœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}

  // Load monsters
  const monsters=[];
  (await getDocs(collection(db,'monsters'))).forEach(doc=>{const d=doc.data();d.marker=null;monsters.push(d);});

  // Update user marker
  let userCircle, first=true;
  function updateUserMarker(lat,lon){
    const icon=L.icon({iconUrl:'../images/face.png',iconSize:[80,80],iconAnchor:[16,16]});
    if(!map.userMarker){
      map.userMarker=L.marker([lat,lon],{icon}).addTo(map).bindPopup('my puppy');
      map.userMarker.on('click',()=>{ if(soundOn) barkSound.play(); });
    } else map.userMarker.setLatLng([lat,lon]);
    if(first){map.setView([lat,lon],19);first=false;}
    if(userCircle) map.removeLayer(userCircle);
    userCircle=L.circle([lat,lon],{radius:50,color:'blue',fillOpacity:0.2}).addTo(map);
  }

  // Initial location
  if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>updateUserMarker(p.coords.latitude,p.coords.longitude));

  // Watch position & game logic
  navigator.geolocation.watchPosition(async p=>{
    const lat=p.coords.latitude, lon=p.coords.longitude;
    updateUserMarker(lat,lon);
    monsters.forEach(m=>{
      const dist=getDistance(lat,lon,m.lat,m.lon);
      if(dist<=20 && !m.marker){
        m.marker=L.marker([m.lat,m.lon]).addTo(map);
        m.marker.on('click',async ()=>{
          if(soundOn) clickSound.play();
          try{
            const tx=await contract.hunt(m.mid,m.pass); const rc=await tx.wait(); let reward=0;
            rc.events.forEach(e=>{ if(e.event==='RewardGiven') reward=parseInt(e.args.rewardAmount.toString(),10); });
            if(reward>0){ if(soundOn) successSound.play(); showEvent('reward',`+${reward} GP`,reward); }
            else{ if(soundOn) failureSound.play(); showEvent('lost','ÌöçÎìù Ïã§Ìå®',0);}            
            map.removeLayer(m.marker); m.marker=null;
          }catch(err){ if(soundOn) failureSound.play(); showEvent('lost','ÏóêÎü¨ Î∞úÏÉù',0); }
        });
      }
    });
  }, err => console.error(err), { enableHighAccuracy: true });

  // Controls
  document.getElementById('locateBtn').onclick=()=>navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],19));
  document.getElementById('homeBtn').onclick=()=>location.href='/';
  document.getElementById('soundToggle').onclick=()=>{soundOn=!soundOn;document.getElementById('soundToggle').textContent=soundOn?'üîä':'üîá';};
}
initialize();
  </script>
</body>
</html>
