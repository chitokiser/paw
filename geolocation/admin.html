<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GeoHunt ê´€ë¦¬ì í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    :root { --blue:#2563eb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; color:#111827; }
    h2 { margin: 0 0 12px; }
    .pill { display:inline-block; padding:2px 8px; background:#eef2ff; color:#3730a3; border-radius:999px; font-size:12px; margin-left:6px; }
    #map { height: 420px; margin-bottom: 10px; border-radius: 10px; overflow: hidden; }
    .info { font-size: 13px; color:#374151; margin: 6px 0 12px; }
    .tabs { display:flex; gap:8px; margin: 10px 0 14px; }
    .tab-btn { padding:10px 14px; border:1px solid #e5e7eb; border-radius:10px; background:#f8fafc; cursor:pointer; }
    .tab-btn.active { background:var(--blue); color:#fff; border-color:var(--blue); }
    .panel { display:none; border:1px solid #eef2f7; padding:14px; border-radius:12px; }
    .panel.active { display:block; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 720px){ .row { grid-template-columns: 1fr; } }
    label { font-size:12px; color:#4b5563; margin: 6px 0 4px; display:block; }
    input, select, button { width:100%; padding:10px 12px; margin:5px 0; border:1px solid #e5e7eb; border-radius:10px; background:#fff; font: inherit; }
    small.hint { color:#6b7280; display:block; margin-top:-3px; }
    button[type=submit] { background:#111827; color:#fff; font-weight:700; cursor:pointer; }
    .subhead { font-weight:700; margin: 10px 0 6px; }
    .sep { height:1px; background:#edf2f7; margin:12px 0; }
  </style>
</head>
<body>
  <h2>GeoHunt ê´€ë¦¬ì í˜ì´ì§€ <span class="pill">ëª¬ìŠ¤í„° &amp; ë²™ì»¤ ë“±ë¡</span></h2>

  <div id="map"></div>
  <div class="info">ì„ íƒ ì¢Œí‘œ: <span id="coordText">-</span></div>

  <div class="tabs">
    <button class="tab-btn active" data-target="monsterPanel">ëª¬ìŠ¤í„° ë“±ë¡</button>
    <button class="tab-btn" data-target="bunkerPanel">ë²™ì»¤ ë“±ë¡</button>
  </div>

  <!-- ëª¬ìŠ¤í„° ë“±ë¡ -->
  <section id="monsterPanel" class="panel active">
    <form id="monsterForm" autocomplete="off">
      <div class="row">
        <div>
          <label for="mid">ëª¬ìŠ¤í„° ID (mid)</label>
          <input type="number" id="mid" placeholder="ì˜ˆ: 101" required />
        </div>
        <div>
          <label for="pass">ê´€ë¦¬ ë¹„ë°€ë²ˆí˜¸ (pass)</label>
          <input type="number" id="pass" placeholder="ìˆ«ì ë¹„ë°€ë²ˆí˜¸" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="imageURL">ë¯¸ë‹ˆë§µ/ê³ ì • ì´ë¯¸ì§€ URL <small class="hint">(ì„ íƒ, ìŠ¤í”„ë¼ì´íŠ¸ ì“°ë©´ ìƒëµ ê°€ëŠ¥)</small></label>
          <input type="url" id="imageURL" placeholder="https://.../marker.png" />
        </div>
        <div>
          <label for="difficulty">ë‚œì´ë„(ì„ íƒ)</label>
          <input type="number" id="difficulty" placeholder="ì˜ˆ: 3" />
        </div>
      </div>

      <div class="sep"></div>
      <div class="subhead">ìŠ¤í”„ë¼ì´íŠ¸ ì‹œíŠ¸</div>
      <div class="row">
        <div>
          <label for="walkImg">Walk ì‹œíŠ¸ URL</label>
          <input type="text" id="walkImg" placeholder="/geolocation/sprites/1.png" />
          <small class="hint">ê¸°ë³¸ê°’: /geolocation/sprites/1.png</small>
        </div>
        <div>
          <label for="atkImg">Attack ì‹œíŠ¸ URL</label>
          <input type="text" id="atkImg" placeholder="/geolocation/sprites/1.png" />
          <small class="hint">í•œ ì¥ ì‹œíŠ¸ ì‚¬ìš©í•˜ëŠ” ê²½ìš° Walkì™€ ë™ì¼</small>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="walkFrames">Walk í”„ë ˆì„ ìˆ˜</label>
          <input type="number" id="walkFrames" value="6" />
        </div>
        <div>
          <label for="walkFps">Walk FPS</label>
          <input type="number" id="walkFps" value="8" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="atkFrames">Attack í”„ë ˆì„ ìˆ˜</label>
          <input type="number" id="atkFrames" value="4" />
        </div>
        <div>
          <label for="atkFps">Attack FPS</label>
          <input type="number" id="atkFps" value="10" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="frameW">í”„ë ˆì„ í­(px)</label>
          <input type="number" id="frameW" value="80" />
        </div>
        <div>
          <label for="frameH">í”„ë ˆì„ ë†’ì´(px)</label>
          <input type="number" id="frameH" value="80" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="rotOffset">ê¸°ë³¸ íšŒì „ ë³´ì •(ë„)</label>
          <input type="number" id="rotOffset" value="0" />
          <small class="hint">ìŠ¤í”„ë¼ì´íŠ¸ê°€ ë™ìª½ì„ ë³´ì§€ ì•Šìœ¼ë©´ +90 ë“±ìœ¼ë¡œ ë³´ì •</small>
        </div>
        <div>
          <label for="attackType">ê³µê²© íƒ€ì…</label>
          <select id="attackType">
            <option value="melee">melee(ê·¼ì ‘)</option>
            <option value="projectile">projectile(íˆ¬ì‚¬ì²´)</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>
      <div class="subhead">í–‰ë™ íŒŒë¼ë¯¸í„°</div>
      <div class="row">
        <div>
          <label for="speed">ì´ë™ ì†ë„ (m/s)</label>
          <input type="number" id="speed" value="1.2" step="0.1" />
        </div>
        <div>
          <label for="patrolRadius">ë°°íšŒ ë°˜ê²½ (m)</label>
          <input type="number" id="patrolRadius" value="8" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="aggroRange">ì¶”ê²© ê°œì‹œ ë²”ìœ„ (m)</label>
          <input type="number" id="aggroRange" value="12" />
        </div>
        <div>
          <label for="attackRange">ê³µê²© ë²”ìœ„ (m)</label>
          <input type="number" id="attackRange" value="6" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="attackCooldownMs">ê³µê²© ì¿¨ë‹¤ìš´ (ms)</label>
          <input type="number" id="attackCooldownMs" value="3000" />
        </div>
        <div></div>
      </div>

      <button type="submit">ëª¬ìŠ¤í„° ë“±ë¡</button>
    </form>
  </section>

  <!-- ë²™ì»¤ ë“±ë¡ -->
  <section id="bunkerPanel" class="panel">
    <form id="bunkerForm" autocomplete="off">
      <div class="row">
        <div>
          <label for="bunkerPass">ê´€ë¦¬ ë¹„ë°€ë²ˆí˜¸ (pass)</label>
          <input type="number" id="bunkerPass" placeholder="ìˆ«ì ë¹„ë°€ë²ˆí˜¸" required />
        </div>
        <div>
          <label for="range">ì‚¬ê±°ë¦¬ range (m)</label>
          <input type="number" id="range" min="1" value="5" required />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="cooldownMs">ì¬ì¥ì „ ì‹œê°„ cooldownMs (ms)</label>
          <input type="number" id="cooldownMs" min="300" value="4000" required />
        </div>
        <div>
          <label for="arrowSpeed">í™”ì‚´ ì†ë„ arrowSpeed (m/s)</label>
          <input type="number" id="arrowSpeed" min="1" value="40" required />
        </div>
      </div>
      <button type="submit">ë²™ì»¤ ë“±ë¡</button>
    </form>
  </section>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script type="module">
    /* ---------------- Firebase ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoeMQt7UZzNHFt22bnGv_-6g15BnwCEBA",
      authDomain: "puppi-d67a1.firebaseapp.com",
      projectId: "puppi-d67a1",
      storageBucket: "puppi-d67a1.appspot.com",
      messagingSenderId: "552900371836",
      appId: "1:552900371836:web:88fb6c6a7d3ca3c84530f9",
      measurementId: "G-9TZ81RW0PL"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------------- Map: í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ë§Œ! ---------------- */
    let map;                       // ì „ì—­ ì°¸ì¡°
    let clickedLatLng = null;
    let currentMarker = null;
    let bunkerRangeCircle = null;

    // ì§€ë„ë¥¼ ë¨¼ì € ë§Œë“¤ê³ , ì´í›„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
    function createMap(initialCenter=[37.5665,126.9780], zoom=13){
      map = L.map('map').setView(initialCenter, zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // ê²€ìƒ‰ ì»¨íŠ¸ë¡¤
      L.Control.geocoder({ defaultMarkGeocode: false })
        .on('markgeocode', (e) => {
          const bbox = e.geocode.bbox;
          const poly = L.polygon([
            bbox.getSouthEast(), bbox.getNorthEast(), bbox.getNorthWest(), bbox.getSouthWest()
          ]);
          map.fitBounds(poly.getBounds());
          setClicked(e.geocode.center);
        })
        .addTo(map);

      // í´ë¦­ìœ¼ë¡œ ì¢Œí‘œ ì„ íƒ
      map.on('click', (e) => setClicked(e.latlng));
    }

    // í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™(ê¶Œí•œ í—ˆìš© ì‹œ)
    function centerToCurrentPosition(){
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const { latitude:lat, longitude:lng } = pos.coords;
          map.setView([lat,lng], 15);
          L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ í˜„ì¬ ìœ„ì¹˜").openPopup();
        },
        (err)=>{ console.warn('Geolocation ì‹¤íŒ¨:', err); },
        { enableHighAccuracy:true, timeout:8000, maximumAge:30000 }
      );
    }

    function setClicked(latlng){
      clickedLatLng = latlng;
      document.getElementById('coordText').textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.marker(latlng).addTo(map).bindPopup("ìœ„ì¹˜ ì„ íƒë¨").openPopup();
      drawBunkerRangePreview();
    }

    function drawBunkerRangePreview(){
      const bunkerPanel = document.getElementById('bunkerPanel');
      const panelOpen = bunkerPanel.classList.contains('active');
      const range = Number(document.getElementById('range').value || 5);
      if (bunkerRangeCircle) { map.removeLayer(bunkerRangeCircle); bunkerRangeCircle = null; }
      if (panelOpen && clickedLatLng && !isNaN(range) && range>0){
        bunkerRangeCircle = L.circle([clickedLatLng.lat, clickedLatLng.lng], {
          radius: range, color:'#ff3b30', fillColor:'#ff3b30', fillOpacity:0.1, weight:1
        }).addTo(map);
      }
    }

    /* ---------------- Tabs ---------------- */
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById(btn.dataset.target).classList.add('active');
      drawBunkerRangePreview();
    }));
    document.getElementById('range').addEventListener('input', drawBunkerRangePreview);

    /* ---------------- Helpers ---------------- */
    const $  = (id) => document.getElementById(id);
    const num = (id, def=null) => {
      const v = $(id).value; if (v==="" || v==null) return def;
      const n = Number(v); return isNaN(n) ? def : n;
    };
    const str = (id) => ($(id).value || '').trim();
    const checkPass = (_) => true; // ìš´ì˜ì€ Firestore ë³´ì•ˆê·œì¹™ë¡œ ì œí•œ ê¶Œì¥

    /* ---------------- Submit: Monster ---------------- */
    $('monsterForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!clickedLatLng) return alert("ì§€ë„ë¥¼ í´ë¦­í•´ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

      const mid  = num('mid'); const pass = num('pass');
      if (!mid || !pass) return alert("mid/passë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (!checkPass(pass)) return alert("íŒ¨ìŠ¤ì›Œë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      const payload = {
        lat: clickedLatLng.lat, lon: clickedLatLng.lng,
        mid, pass,
        ...(str('imageURL') ? { imagesURL: str('imageURL') } : {}),
        ...(num('difficulty') ? { difficulty: num('difficulty') } : {}),
        ...(str('walkImg') ? { walkImg: str('walkImg') } : {}),
        ...(str('atkImg')  ? { atkImg:  str('atkImg')  } : {}),
        walkFrames: num('walkFrames', 6),
        walkFps:    num('walkFps', 8),
        atkFrames:  num('atkFrames', 4),
        atkFps:     num('atkFps', 10),
        frameW:     num('frameW', 80),
        frameH:     num('frameH', 80),
        rotOffset:  num('rotOffset', 0),
        speed:            num('speed', 1.2),
        patrolRadius:     num('patrolRadius', 8),
        aggroRange:       num('aggroRange', 12),
        attackRange:      num('attackRange', 6),
        attackCooldownMs: num('attackCooldownMs', 3000),
        attackType:       $('attackType').value || 'melee',
      };

      await addDoc(collection(db, "monsters"), payload);

      alert("ëª¬ìŠ¤í„° ë“±ë¡ ì™„ë£Œ!");
      e.target.reset();
      if (currentMarker) { map.removeLayer(currentMarker); currentMarker = null; }
      if (bunkerRangeCircle) { map.removeLayer(bunkerRangeCircle); bunkerRangeCircle = null; }
      clickedLatLng = null; $('coordText').textContent = '-';
    });

    /* ---------------- Submit: Bunker ---------------- */
    $('bunkerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!clickedLatLng) return alert("ì§€ë„ë¥¼ í´ë¦­í•´ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

      const pass = num('bunkerPass');
      const range = num('range');
      const cooldownMs = num('cooldownMs');
      const arrowSpeed = num('arrowSpeed');

      if (!checkPass(pass)) return alert("íŒ¨ìŠ¤ì›Œë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      if (!range || range <= 0) return alert("rangeëŠ” 1 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
      if (!cooldownMs || cooldownMs < 300) return alert("cooldownMsëŠ” 300ms ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      if (!arrowSpeed || arrowSpeed <= 0) return alert("arrowSpeedëŠ” 1 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");

      await addDoc(collection(db, "bunkers"), {
        lat: clickedLatLng.lat, lon: clickedLatLng.lng,
        range, cooldownMs, arrowSpeed, pass
      });

      alert("ë²™ì»¤ ë“±ë¡ ì™„ë£Œ!");
      e.target.reset();
      if (currentMarker) { map.removeLayer(currentMarker); currentMarker = null; }
      if (bunkerRangeCircle) { map.removeLayer(bunkerRangeCircle); bunkerRangeCircle = null; }
      clickedLatLng = null; $('coordText').textContent = '-';
    });

    /* ---------------- Start ---------------- */
    createMap();              // 1) ì§€ë„ ìƒì„±(ê¸°ë³¸ ì¢Œí‘œ)
    centerToCurrentPosition(); // 2) ê¶Œí•œ í—ˆìš© ì‹œ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
  </script>
</body>
</html>
