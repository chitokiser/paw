<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Puppy Market · PAW DAO"/>
  <meta name="author" content="PAW DAO"/>
  <link rel="shortcut icon" href="../images/logo.png"/>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- ethers.js v6 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
  <title>Puppy Market · PAW DAO</title>
  <style>
    :root{
      --bg:#0b0d14;
      --glass:rgba(255,255,255,.06);
      --glass-2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.12);
      --text:#e9eefc; --muted:#a9b1c7;
      --grad:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%);
      --radius:16px;
    }
    html,body{ background:var(--bg); color:var(--text); min-height:100%; }
    .container-narrow{ max-width:980px; margin:0 auto; padding:16px; }
    .glass-card{
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:var(--radius);
      backdrop-filter:saturate(140%) blur(8px);
      -webkit-backdrop-filter:saturate(140%) blur(8px);
      box-shadow:0 8px 24px rgba(0,0,0,.35);
    }
    .card-header{ background:transparent; border-bottom:1px solid var(--border); }
    .card-body p{ color:var(--muted); margin-bottom:.5rem; }
    .btn-primary{ background-image:var(--grad); border:0; }
    .btn:focus{ box-shadow:0 0 0 .2rem rgba(124,58,237,.3); }
    .market-grid{
      display:grid; gap:12px;
      grid-template-columns:repeat(2,minmax(0,1fr));
    }
    @media (max-width: 640px){
      .market-grid{ grid-template-columns:1fr; }
    }
    .puppy-card{
      background:var(--glass-2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .puppy-img{
      width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px; border:1px solid var(--border);
    }
    .info{ font-size:.95rem; color:var(--muted); }
    .price{ font-weight:700; margin-top:6px; }
    .badge-soft{
      background:rgba(124,58,237,.18);
      color:#d8c9ff;
      border:1px solid rgba(124,58,237,.35);
    }
    .stat-bars{ display:flex; flex-direction:column; gap:6px; margin-top:8px; }
    .stat-line{ display:flex; align-items:center; gap:8px; }
    .stat-label{ width:40px; font-size:.8rem; color:#cfd7f3; }
    .stat-bar-horizontal{ flex:1; height:10px; border-radius:6px; overflow:hidden; background:rgba(255,255,255,.12); }
    .stat-bar-fill{ height:100%; background-image:var(--grad); }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .muted{ color:var(--muted); }
    a, a:visited{ color:#cbd5ff; }
  </style>
</head>
<body>
  <!-- Topbar include (safe) -->
  <div id="menu-placeholder" class="container-narrow"></div>

  <main class="container-narrow" aria-live="polite">
    <section class="glass-card mb-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Puppy Market</h5>
        <span class="badge badge-soft px-2 py-1 rounded-pill">opBNB Mainnet</span>
      </div>
      <div class="card-body">
        <div class="toolbar">
          <div>
            <div id="contractBalance" class="fw-bold">Contract Balance: –</div>
            <div id="myPuppyPrice" class="fw-bold">My Puppy Price: –</div>
          </div>
          <button id="btnRefresh" class="btn btn-outline-light btn-sm" type="button" aria-label="Refresh data">Refresh</button>
        </div>
        <hr class="text-white-50"/>
        <p>• Selling price is auto-calculated from your dog’s total stats and level.</p>
        <p>• A dog must be worth at least <strong>5 PAW</strong> to be listed.</p>
        <p>• If someone lists in the same slot after you, yours is automatically sold.</p>
        <p>• You must not own any dog to buy a listed one.</p>
        <p class="muted">• Wallets supported: MetaMask / Rabby (EIP-6963).</p>
      </div>
    </section>

    <h6 class="muted mb-2">Listings</h6>
    <section id="listing-container" class="market-grid"></section>
  </main>

  <!-- Footer include (safe) -->
  <div id="footer" class="container-narrow my-4 small muted"></div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>

  <script>
  /***********************
   * CONFIG & CONTRACTS  *
   ***********************/
  const pmRPCS = [
    "https://opbnb-mainnet-rpc.bnbchain.org",
    "https://opbnb-rpc.publicnode.com",
    "https://opbnb.blockpi.network/v1/rpc/public",
    "https://1rpc.io/opbnb"
  ];
  const pmNET = { chainId: 204, name: "opBNB" };

  const pmCONTRACT = {
    puppymarket: "0xE14eC3de50be7f66d9cA962ECFb86f842b6e6d76",
    paw:         "0xCC1ce312b7A7C4A78ffBf51F8fc0e087C1D4c72f",
    puppy:       "0x4ceDeF50FB76113be3c65e59e5da11E85e53e22d"
  };

  const pmABI = {
    puppymarket: [
      "function calculatePrice(uint256 _pid) view returns (uint256)",
      "function max() view returns (uint256)",
      "function ls(uint256) view returns (uint256 bid, address owner, uint256 price)",
      "function listPuppy()",
      "function buyPuppy(uint256 _mid)",
      "function g1() view returns(uint256)",
      "event PuppyListed(uint256 pid, address seller, uint256 price)",
      "event PuppySold(uint256 pid, address buyer, uint256 price)",
      "event PuppyDelisted(uint256 pid)"
    ],
    puppy: [
      "function myPuppyid(address user) view returns (uint256)",
      "function getowner(uint256 _pid) view returns (address)"
    ],
    erc20: [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ]
  };

  /***********************
   * PROVIDER & CONTRACT *
   ***********************/
  let pmProvider, pmMarket, pmPuppy, pmPAW;

  async function pmPickProvider(){
    for (const url of pmRPCS){
      try{
        const p = new ethers.JsonRpcProvider(url, pmNET);
        await Promise.race([ p.getBlockNumber(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),4000)) ]);
        return p;
      }catch(e){ console.warn("[RPC] Unavailable:", url, e?.message||e); }
    }
    throw new Error("All RPC endpoints failed.");
  }

  async function pmEnsure(){
    if (!pmProvider) pmProvider = await pmPickProvider();
    if (!pmMarket){
      pmMarket = new ethers.Contract(pmCONTRACT.puppymarket, pmABI.puppymarket, pmProvider);
      pmPuppy  = new ethers.Contract(pmCONTRACT.puppy,       pmABI.puppy,       pmProvider);
      pmPAW    = new ethers.Contract(pmCONTRACT.paw,         pmABI.erc20,       pmProvider);
    }
  }

  /***********************
   * UI HELPERS          *
   ***********************/
  function pmToast(msg){
    try {
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.position = "fixed";
      el.style.left = "50%";
      el.style.bottom = "24px";
      el.style.transform = "translateX(-50%)";
      el.style.background = "rgba(0,0,0,.75)";
      el.style.color = "#fff";
      el.style.padding = "10px 14px";
      el.style.borderRadius = "10px";
      el.style.zIndex = "9999";
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 2200);
    } catch {}
  }
  const pmShort = a => a ? (a.slice(0,6)+"…"+a.slice(-4)) : "-";
  const pmStatBar = (name,val,max=100)=>{
    const pct = Math.max(0, Math.min(100, Math.round((Number(val)||0)/max*100)));
    return `
      <div class="stat-line">
        <div class="stat-label">${name}</div>
        <div class="stat-bar-horizontal"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
      </div>`;
  };

  /***********************
   * INCLUDES (safe)     *
   ***********************/
  async function pmSafeFetchText(url){
    try{
      const res = await fetch(url, { cache: "no-cache" });
      if (!res.ok) throw new Error(String(res.status));
      const ct = res.headers.get("content-type") || "";
      if (!ct.includes("text/html")) throw new Error("Not HTML");
      return await res.text();
    }catch(e){
      console.warn("[include] failed:", url, e?.message || e);
      return null;
    }
  }

  // ★ 대시보드 붙인 직후 topinfo.js의 topData()를 반드시 실행
  async function pmLoadIncludes(){
    // header
    const top = await pmSafeFetchText("dashboard.html");
    if (top){
      const host = document.getElementById("menu-placeholder");
      if (host) host.innerHTML = top;

      if (typeof window.topData === "function") {
        try { window.topData(); } catch(e){ console.warn("topData() failed:", e); }
      } else {
        try{
          const s = document.createElement("script");
          s.src = "../src/topinfo.js";
          s.defer = true;
          s.onload = () => {
            try { typeof window.topData === "function" && window.topData(); }
            catch(e){ console.warn("topData() failed:", e); }
          };
          s.onerror = () => console.warn("topinfo.js load skipped");
          document.body.appendChild(s);
        }catch{}
      }
    }
    // footer
    const foot = await pmSafeFetchText("../footer.html");
    if (foot){
      const host = document.getElementById("footer");
      if (host) host.innerHTML = foot;
    }
  }

  /***********************
   * CORE FUNCTIONS      *
   ***********************/
  async function pmGetContractBalance(){
    try{
      await pmEnsure();
      const bal = await pmMarket.g1();
      const display = ethers.formatUnits(bal, 18);
      const el = document.getElementById("contractBalance");
      if (el) el.textContent = `Contract Balance: ${display} PAW`;
    }catch(e){
      console.error("pmGetContractBalance()", e);
      const el = document.getElementById("contractBalance");
      if (el) el.textContent = "Contract Balance: failed to load";
      pmToast("Failed to load contract balance.");
    }
  }

  async function pmShowMyPuppyPrice(){
    try{
      if (!window.ethereum){ pmToast("Wallet required (MetaMask/Rabby)."); return; }
      const [acc] = await window.ethereum.request({ method:"eth_requestAccounts" });
      const web3 = new ethers.BrowserProvider(window.ethereum, pmNET);
      const signer = await web3.getSigner();

      const puppyRW = new ethers.Contract(pmCONTRACT.puppy, pmABI.puppy, signer);
      const pid = await puppyRW.myPuppyid(acc);

      const host = document.getElementById("myPuppyPrice");
      if (!host) return;

      if (BigInt(pid) === 0n){
        host.innerHTML = `My Puppy Price: N/A (no puppy owned)`;
        return;
      }

      const marketRW = new ethers.Contract(pmCONTRACT.puppymarket, pmABI.puppymarket, signer);
      const raw = await marketRW.calculatePrice(pid);
      const price = ethers.formatUnits(raw, 18);

      host.innerHTML = `
        My Puppy Price: ${Number(price).toFixed(2)} PAW
        <button class="btn btn-success btn-sm ms-2" id="btnList" type="button">List My Puppy</button>
      `;
      const btn = document.getElementById("btnList");
      if (btn) btn.onclick = () => pmListMyPuppy();
    }catch(e){
      console.error("pmShowMyPuppyPrice()", e);
      const el = document.getElementById("myPuppyPrice");
      if (el) el.textContent = "My Puppy Price: failed to load";
      pmToast("Failed to load my puppy price.");
    }
  }

  async function pmListMyPuppy(){
    try{
      if (!window.ethereum){ pmToast("Wallet required (MetaMask/Rabby)."); return; }
      const web3 = new ethers.BrowserProvider(window.ethereum, pmNET);
      const signer = await web3.getSigner();

      const marketRW = new ethers.Contract(pmCONTRACT.puppymarket, pmABI.puppymarket, signer);
      const tx = await marketRW.listPuppy();
      pmToast("Listing submitted…");
      await tx.wait();
      pmToast("Listing completed.");
      await pmFetchAllListings();
    }catch(e){
      console.error("pmListMyPuppy()", e);
      pmToast("Listing failed: " + (e?.info?.error?.message || e?.message || "unknown error"));
    }
  }

  async function pmBuyPuppy(mid){
    try{
      if (!window.ethereum){ pmToast("Wallet required (MetaMask/Rabby)."); return; }
      const [user] = await window.ethereum.request({ method:"eth_requestAccounts" });

      const web3 = new ethers.BrowserProvider(window.ethereum, pmNET);
      const signer = await web3.getSigner();

      await pmEnsure();
      const listing = await pmMarket.ls(mid);
      const bid   = listing[0];
      const owner = listing[1];
      const price = listing[2];

      if (price === 0n){ pmToast("Empty slot. Nothing to buy."); return; }

      const bal = await pmPAW.balanceOf(user);
      if (bal < price){ pmToast("Insufficient PAW balance."); return; }

      const marketRW = new ethers.Contract(pmCONTRACT.puppymarket, pmABI.puppymarket, signer);
      const tx = await marketRW.buyPuppy(mid);
      pmToast("Purchase submitted…");
      await tx.wait();
      pmToast("Puppy purchase completed.");
      await pmFetchAllListings();
    }catch(e){
      console.error("pmBuyPuppy()", e);
      pmToast("Purchase failed: " + (e?.info?.error?.message || e?.message || "unknown error"));
    }
  }

  async function pmFetchAllListings(){
    try{
      await pmEnsure();
      const container = document.getElementById("listing-container");
      if (!container) return;
      container.innerHTML = "";

      const max = await pmMarket.max();
      const N = Number(max);

      for (let i=1; i<=N; i++){
        const item = await pmMarket.ls(i);
        pmRenderCard(i, item[0], item[1], item[2]);
      }
    }catch(e){
      console.error("pmFetchAllListings()", e);
      pmToast("Failed to load listings.");
    }
  }

  function pmRenderCard(mid, bid, owner, price){
    const container = document.getElementById("listing-container");
    if (!container) return;

    const el = document.createElement("div");
    el.className = "puppy-card";

    const isEmpty = (price === 0n);
    const priceDisplay = isEmpty ? "Empty Slot" : `${Number(ethers.formatUnits(price,18)).toFixed(2)} PAW`;
    const ownerShort = owner && owner !== ethers.ZeroAddress ? pmShort(owner) : (isEmpty ? "-" : pmShort(owner));

    const imagePath = `images/puppy/${bid}.png`;
    el.innerHTML = `
      <div class="row g-2 align-items-center">
        <div class="col-4">
          <img class="puppy-img" src="${imagePath}" loading="lazy" alt="Puppy ${bid}"/>
        </div>
        <div class="col-8">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Puppy #${mid}</h6>
            ${isEmpty ? `<span class="badge text-bg-secondary">Available</span>` : `<span class="badge text-bg-light">Listed</span>`}
          </div>
          <div class="info mt-1"><strong>Bid:</strong> ${bid}</div>
          <div class="info"><strong>Owner:</strong> ${ownerShort}</div>
          <div class="price">${priceDisplay}</div>
          <div class="stat-bars">
            ${pmStatBar("ATK", (Number(bid)%30)+50, 100)}
            ${pmStatBar("DEF", (Number(bid)%25)+45, 100)}
          </div>
          ${isEmpty
            ? `<button class="btn btn-secondary btn-sm mt-2" type="button" disabled>Empty</button>`
            : `<button class="btn btn-primary btn-sm mt-2" type="button" onclick="pmBuyPuppy(${mid})" style="min-height:44px;min-width:120px;">Buy</button>`
          }
        </div>
      </div>
    `;
    container.appendChild(el);
  }

  /***********************
   * BOOT                *
   ***********************/
  window.addEventListener("load", async ()=>{
    await pmLoadIncludes();

    const btn = document.getElementById("btnRefresh");
    if (btn){
      btn.addEventListener("click", async ()=>{
        await pmGetContractBalance();
        await pmShowMyPuppyPrice();
        await pmFetchAllListings();
        pmToast("Refreshed.");
      });
    }

    await pmGetContractBalance();
    await pmShowMyPuppyPrice();
    await pmFetchAllListings();
  });

  // Minimal globals (only what buttons need)
  window.pmBuyPuppy = pmBuyPuppy;
  window.pmListMyPuppy = pmListMyPuppy;
  </script>
</body>
</html>
