  <!-- HiPuppy.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>HiPuppy ¬∑ PAW DAO</title>

  <!-- Bootstrap (single) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"/>

  <style>
    :root{
      --bg:#0b0d14; --text:#eef3ff; --muted:#a9b1c7;
      --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
      --radius:16px; --tap:48px;
      --accent:#43d17a; --danger:#ff5b6e; --warn:#ffb25c; --info:#38bdf8;
    }
    body{ background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }
    .container{ max-width: 920px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); backdrop-filter: blur(6px); }
    .card-header{ border-bottom:1px solid var(--border); }
    .btn{ min-height:var(--tap); border-radius:14px; font-weight:600; }
    .pill{ background:rgba(255,255,255,.08); border:1px solid var(--border); border-radius:999px; padding:.25rem .6rem; font-size:12px; }
    .mini{ font-size:12px; color:var(--muted); }
    .grid-3{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
    .stack-sm>*{ margin-right:.5rem; }
    @media (max-width: 576px){
      .stack-sm{ display:flex; flex-direction:column; gap:.5rem; }
      .stack-sm>*{ width:100%!important; margin:0!important; }
    }
    .slot-cell{ background:rgba(255,255,255,.04); border:1px dashed var(--border); border-radius:12px; height:88px; display:flex; align-items:center; justify-content:center; }
    .slot-img{ width:56px; height:56px; object-fit:contain; }
    #log{ max-height:220px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; background:rgba(0,0,0,.25); border-radius:12px; padding:10px; }

    /* Overlay animation (dogs running in) */
    #dogRunOverlay{
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.45); backdrop-filter: blur(2px); z-index: 9999;
    }
    #dogRunStage{ position:relative; width:100%; max-width:680px; height:220px; }
    .dog-runner{ position:absolute; left:-140px; top:50%; width:96px; height:96px; transform:translateY(-50%) scale(.8) rotate(-8deg); opacity:.7; }
    @keyframes runToCenter {
      0%   { left:-140px; opacity:.7; transform:translateY(-50%) scale(.8) rotate(-8deg); }
      70%  { opacity:1; transform:translateY(-50%) scale(1.15) rotate(4deg); }
      85%  { transform:translateY(-50%) scale(1.08) rotate(-2deg); }
      100% { left:50%; transform:translate(-50%, -50%) scale(1.08) rotate(0deg); opacity:1; }
    }
    .dog-runner.play { animation: runToCenter 1.1s cubic-bezier(.9,.3,.4,1.4) forwards; }
    .puppy-img{ width:92px; height:92px; object-fit:contain; border-radius:12px; background: rgba(255,255,255,.05); }
  </style>
</head>
<body>

  <div class="container py-3">

    <!-- Header / Controls -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <div class="mini">Reward rate per matching puppy</div>
          <div class="h4 mb-0">√ó <span id="rateValue">‚Ä¶</span></div>
        </div>
        <div class="stack-sm d-flex align-items-center">
          <a href="WithPuppy.html" class="btn btn-outline-info">üè† Puppy Home</a>
          <button id="btnConnect" class="btn btn-outline-light">üîå Connect Wallet</button>
          <button id="btnRefresh" class="btn btn-outline-secondary">‚Üª Refresh</button>
        </div>
      </div>
    </div>

    <!-- My Puppy + Quick Info -->
    <div class="card mb-3">
      <div class="card-header"><strong>My Puppy</strong></div>
      <div class="card-body d-flex align-items-center gap-3">
        <img id="myBreedImg" class="puppy-img" src="/images/puppy/question.png" alt="My Puppy"/>
        <div class="mini">
          Shown after your first play (or when DebugBreed event is emitted).
        </div>
      </div>
    </div>

    <!-- Slot board -->
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <strong>Puppy Call (slot)</strong>
        <span class="pill">Consumes Game Points</span>
      </div>
      <div class="card-body">
        <div id="slotResult" class="grid-3">
          <!-- 3x3 board -->
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
          <div class="slot-cell"><img class="slot-img" src="/images/puppy/0.png" alt="?"/></div>
        </div>

        <div class="mini mt-3">
          When a puppy that matches <strong>your puppy</strong> is called, you get <strong>√ó <span id="rateValue2">‚Ä¶</span></strong> per match.
          Random ability bonus may apply.
        </div>

        <hr class="my-3"/>

        <label for="betAmount" class="mini">GamePoint to spend</label>
        <input type="number" id="betAmount" class="form-control mb-2 text-center" placeholder="e.g. 10" min="1" value="10"/>

        <div class="d-flex gap-2 stack-sm">
          <button id="btnPlay" class="btn btn-success w-100">üêæ Puppy Call</button>
        </div>

        <div class="row g-2 mt-3">
          <div class="col-12 col-sm-4"><strong>Matching Count:</strong> <span id="matchCount" class="text-info">0</span></div>
          <div class="col-12 col-sm-4"><strong>Base Reward:</strong> <span id="rewardAmount" class="text-success">0</span> GP</div>
          <div class="col-12 col-sm-4"><strong>Ability Bonus:</strong> <span id="bonusAmount" class="text-warning">0</span></div>
        </div>
      </div>
    </div>

    <!-- Event Log -->
    <div class="card mb-4">
      <div class="card-header"><strong>Event Log</strong></div>
      <div class="card-body">
        <div id="log">Ready.</div>
      </div>
    </div>
  </div>

  <!-- Dogs running overlay + sound -->
  <div id="dogRunOverlay">
    <div id="dogRunStage"></div>
  </div>
  <audio id="barkSound" src="/sounds/bark.mp3" preload="auto"></audio>

  <!-- Vendor scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- App -->
  <script>
  (function(g){
    const { ethers } = g;

    /* ---------- Contract address & ABI ---------- */
    const HIPUPPY_ADDR = "0x188A8747a2D477206885D9f8f4FB00e95941a661"; // HiPuppy
    const ABI = [
      "function playSlot(uint _pay) external",
      "function rate() view returns(uint8)",
      "event lost(uint amount)",
      "event Bonus(address indexed user,uint amount,uint256 reward)",
      "event RewardGiven(address indexed user, uint amount, uint reward)",
      "event DebugBreed(uint8 myPuppy, uint8 matchCount, uint8[9] slotValues)"
    ];

    /* ---------- RPC fallback (read) ---------- */
    const OPBNB_RPCS = [
      "https://opbnb-mainnet-rpc.bnbchain.org",
      "https://opbnb-rpc.publicnode.com",
      "https://opbnb.blockpi.network/v1/rpc/public",
      "https://1rpc.io/opbnb"
    ];
    let __readProvider=null, __hipuppyRead=null;

    async function pickHealthyRpc(timeoutMs=4000){
      for(const url of OPBNB_RPCS){
        try{
          const p = new ethers.providers.StaticJsonRpcProvider({url, timeout:timeoutMs}, {chainId:204, name:"opbnb"});
          await Promise.race([p.getBlockNumber(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), timeoutMs))]);
          return p;
        }catch{/* try next */}
      }
      throw new Error("No healthy opBNB RPC found");
    }
    async function getRead(){
      if(__readProvider && __hipuppyRead) return {provider:__readProvider, hipuppy:__hipuppyRead};
      __readProvider = await pickHealthyRpc();
      __hipuppyRead  = new ethers.Contract(HIPUPPY_ADDR, ABI, __readProvider);
      return {provider:__readProvider, hipuppy:__hipuppyRead};
    }

    /* ---------- Wallet (write) ---------- */
    let signer=null, hipuppyWrite=null;

    async function ensureOpBNB(userProvider){
      const net = await userProvider.getNetwork();
      if (Number(net.chainId) === 204) return;
      try{
        await g.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0xCC" }] });
      }catch{
        await g.ethereum.request({
          method:"wallet_addEthereumChain",
          params:[{
            chainId:"0xCC",
            rpcUrls:["https://opbnb-mainnet-rpc.bnbchain.org"],
            chainName:"opBNB",
            nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
            blockExplorerUrls:["https://opbnbscan.com"]
          }]
        });
      }
    }

    async function connectWallet(){
      if(!g.ethereum){ alert("Please install a wallet (MetaMask/Rabby)."); return null; }
      const provider = new ethers.providers.Web3Provider(g.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      await ensureOpBNB(provider);
      signer = provider.getSigner();
      hipuppyWrite = new ethers.Contract(HIPUPPY_ADDR, ABI, signer);
      log("üîå Connected: " + await signer.getAddress());
      return true;
    }

    /* ---------- UI helpers ---------- */
    function log(msg){
      const box = document.getElementById("log");
      box.innerHTML = `<div>${new Date().toLocaleTimeString()} ${msg}</div>` + box.innerHTML;
    }
    function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }

    /* ---------- Rate render ---------- */
    async function renderRate(){
      try{
        const { hipuppy } = await getRead();
        const r = await hipuppy.rate();            // uint8
        const x = Number(r)/100;                   // e.g., 1.2x => 120 -> 1.2
        setText("rateValue", x);
        setText("rateValue2", x);
      }catch{
        setText("rateValue", "‚Äî"); setText("rateValue2", "‚Äî");
        log("‚ö†Ô∏è Failed to load rate.");
      }
    }

    /* ---------- Dogs running overlay ---------- */
    const dogImgs = [0,1,2,3,4,5,6,7,8,9].map(n=>`/images/puppy/${n}.png`);
    async function showRunOverlay(){
      const overlay = document.getElementById("dogRunOverlay");
      const stage   = document.getElementById("dogRunStage");
      stage.innerHTML = "";
      // 4~5ÎßàÎ¶¨ Î¨¥ÏûëÏúÑ ÏÑ†ÌÉù
      const count = 4 + Math.floor(Math.random()*2);
      for(let i=0;i<count;i++){
        const img = document.createElement("img");
        img.src = dogImgs[Math.floor(Math.random()*dogImgs.length)];
        img.className = "dog-runner play";
        img.style.animationDelay = `${i*0.15}s`;
        img.style.top = `${30 + i*15}%`;
        stage.appendChild(img);
      }
      overlay.style.display = "flex";
      try{
        const b = document.getElementById("barkSound");
        b.currentTime = 0; b.play().catch(()=>{});
      }catch{}
      await new Promise(res=>setTimeout(res, 1300));
      overlay.style.display = "none";
    }

    /* ---------- Play slot ---------- */
    async function playSlot(){
      if(!hipuppyWrite){ const ok = await connectWallet(); if(!ok) return; }

      const pay = Number(document.getElementById("betAmount").value);
      if(!Number.isFinite(pay) || pay<=0){ alert("Enter a valid GP amount (‚â• 1)."); return; }

      // Reset UI
      setText("matchCount","0"); setText("rewardAmount","0"); setText("bonusAmount","0");
      // keep board as-is until result

      try{
        log("‚è≥ Sending transaction‚Ä¶");
        const tx = await hipuppyWrite.playSlot(pay);
        log("Tx: " + tx.hash);

        // Fun while waiting
        await showRunOverlay();

        const receipt = await tx.wait();
        log("‚úÖ Confirmed: " + tx.hash);

        const iface = new ethers.utils.Interface(ABI);
        let sawResult=false;

        for(const lg of receipt.logs){
          try{
            const parsed = iface.parseLog(lg);
            const { name, args } = parsed;

            if(name === "RewardGiven"){
              sawResult = true;
              const amount = args.amount?.toString?.() ?? String(args.amount);
              const matches = args.reward?.toString?.() ?? String(args.reward); // ABI says "reward", used as matchCount in your code
              setText("matchCount", matches);
              setText("rewardAmount", amount);
              log(`üéâ Reward: ${amount} GP, Matches: ${matches}`);
            }

            if(name === "Bonus"){
              const amount = args.amount?.toString?.() ?? String(args.amount);
              const stat   = args.reward?.toString?.() ?? String(args.reward);
              setText("bonusAmount", `${amount} GP (stat ${stat})`);
              log(`üéÅ Bonus: ${amount} GP (stat ${stat})`);
            }

            if(name === "lost"){
              const amount = args.amount?.toString?.() ?? String(args.amount);
              log(`üò¢ Lost: ${amount} GP`);
            }

            if(name === "DebugBreed"){
              const myPuppy    = Number(args.myPuppy);
              const matchCount = Number(args.matchCount);
              const slots      = Array.from(args.slotValues).map(v => Number(v));

              // My puppy image
              const myImg = document.getElementById("myBreedImg");
              if(myImg) myImg.src = `/images/puppy/${myPuppy}.png`;

              setText("matchCount", matchCount);

              // Render 3x3 board
              const cells = document.querySelectorAll("#slotResult .slot-cell");
              for(let i=0;i<9 && i<cells.length;i++){
                const n = slots[i] ?? 0;
                cells[i].innerHTML = `<img class="slot-img" src="/images/puppy/${n}.png" alt="puppy"/>`;
              }
              log(`üé∞ Slots: ${slots.join(", ")}`);
            }
          }catch{}
        }

        if(!sawResult) log("No result events found.");
        await renderRate();

      }catch(err){
        const msg = err?.message || "Transaction failed.";
        log("‚ùå " + msg);
        alert(msg);
      }
    }

    /* ---------- Bindings ---------- */
    document.getElementById("btnConnect").addEventListener("click", connectWallet);
    document.getElementById("btnRefresh").addEventListener("click", renderRate);
    document.getElementById("btnPlay").addEventListener("click", playSlot);

    /* ---------- Boot ---------- */
    g.addEventListener("load", async ()=>{
      await renderRate();
    });

    // Optional expose
    g.HIP = { connectWallet, playSlot };
  })(window);
  </script>
</body>
</html>
