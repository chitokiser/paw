<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Puppy Race ¬∑ PAW DAO</title>

  <!-- Bootstrap (single) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"/>

  <style>
    :root{
      --bg:#0b0d14; --text:#eef3ff; --muted:#a9b1c7;
      --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
      --radius:16px; --tap:48px;
      --accent:#43d17a; --danger:#ff5b6e; --warn:#ffb25c; --info:#38bdf8;
    }
    body{ background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }
    .container{ max-width: 920px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); backdrop-filter: blur(6px); }
    .card-header{ border-bottom:1px solid var(--border); }
    .btn{ min-height:var(--tap); border-radius:14px; font-weight:600; }
    .badge-soft{ background:rgba(255,255,255,.08); border:1px solid var(--border); }
    .grid-2{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px; }
    .grid-4{ display:grid; grid-template-columns: repeat(4,1fr); gap:12px; }
    @media (max-width: 576px){
      .grid-2{ grid-template-columns: 1fr; }
      .grid-4{ grid-template-columns: repeat(2,1fr); }
      .stack-sm>*{ width:100%!important; margin:.25rem 0!important; }
    }
    #log{ max-height:220px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; background:rgba(0,0,0,.25); border-radius:12px; padding:10px; }
    .mini{ font-size:12px; color:var(--muted); }
    .pill{ background:rgba(255,255,255,.08); border:1px solid var(--border); border-radius:999px; padding:.25rem .6rem; font-size:12px; }
    .puppy-img{ width:92px; height:92px; object-fit:contain; border-radius:12px; background: rgba(255,255,255,.05); }

    /* Race overlay animation */
    #raceAnimOverlay{
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.45); backdrop-filter: blur(2px); z-index: 9999;
    }
    #animDogBig{ width:min(70vw, 360px); height:auto; image-rendering: -webkit-optimize-contrast; border-radius:18px; }
  </style>
</head>
<body>

  <div class="container py-3">

    <!-- Header / Controls -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <div class="mini">Global Jackpot (GP base 100)</div>
          <div class="h4 mb-0"><span id="jackpotValue">‚Ä¶</span></div>
        </div>
        <div class="stack-sm d-flex gap-2">
          <a href="WithPuppy.html" class="btn btn-outline-info">üè† Puppy Home</a>
          <button id="btnConnect" class="btn btn-outline-light">üîå Connect Wallet</button>
          <button id="btnRefresh" class="btn btn-outline-secondary">‚Üª Refresh</button>
        </div>
      </div>
    </div>

    <!-- Prize grid -->
    <div class="card mb-3">
      <div class="card-header"><strong>Prize (Top 8 of 60)</strong></div>
      <div class="card-body">
        <div class="grid-4">
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">ü•á 1st</div>
            <div id="jackpotValue1" class="h6">‚Äî</div>
          </div>
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">ü•à 2nd</div>
            <div id="jackpotValue2" class="h6">‚Äî</div>
          </div>
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">ü•â 3rd</div>
            <div id="jackpotValue3" class="h6">‚Äî</div>
          </div>
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">üê∂ 4th</div>
            <div id="jackpotValue4" class="h6">‚Äî</div>
          </div>
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">üê± 5th</div>
            <div id="jackpotValue5" class="h6">‚Äî</div>
          </div>
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">üê∞ 6th</div>
            <div id="jackpotValue6" class="h6">‚Äî</div>
          </div>
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">üêª 7th</div>
            <div id="jackpotValue7" class="h6">‚Äî</div>
          </div>
          <div class="p-3 rounded text-center" style="border:1px solid var(--border);">
            <div class="h5 mb-1">ü¶ä 8th</div>
            <div id="jackpotValue8" class="h6">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <!-- My Puppy -->
    <div class="card mb-3">
      <div class="card-header"><strong>My Puppy</strong></div>
      <div class="card-body d-flex align-items-center gap-3">
        <img id="myPuppyImg" class="puppy-img" src="/images/puppy/0.png" alt="My Puppy"/>
        <div>
          <div class="mini">Breed</div>
          <div id="myBreed" class="h5 mb-2">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Enter Race -->
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <strong>Enter & Run Race</strong>
        <span class="pill">Ticket: <strong class="ms-1">1</strong> GP each</span>
      </div>
      <div class="card-body">
        <label for="betAmount" class="mini">Tickets (example: 100)</label>
        <input type="number" id="betAmount" class="form-control mb-2 text-center" placeholder="100" min="1" value="100"/>

        <div class="d-flex gap-2 stack-sm">
          <button id="btnRace" class="btn btn-success w-100">üèÅ Start</button>
        </div>

        <div class="grid-2 mt-3">
          <div><strong>Rank:</strong> <span id="raceRank" class="text-info">-</span></div>
          <div><strong>Reward:</strong> <span id="rewardAmount" class="text-success">0</span> GP</div>
          <div><strong>Bonus:</strong> <span id="bonusAmount" class="text-warning">0</span> GP</div>
        </div>
      </div>
    </div>

    <!-- Winners -->
    <div class="card mb-3">
      <div class="card-header"><strong>Recent Winners</strong></div>
      <div class="card-body">
        <div id="winnerList" class="mini">Loading‚Ä¶</div>
      </div>
    </div>

    <!-- Game Log -->
    <div class="card mb-4">
      <div class="card-header"><strong>Game Log</strong></div>
      <div class="card-body">
        <div id="log">Ready.</div>
      </div>
    </div>

  </div>

  <!-- Race overlay + sounds -->
  <div id="raceAnimOverlay">
    <img id="animDogBig" src="/images/puppy/race/0.png" alt="Racing Puppy"/>
  </div>
  <audio id="whistleSound" src="/sounds/whistle.mp3" preload="auto"></audio>
  <audio id="barkSound" src="/sounds/bark.mp3" preload="auto"></audio>

  <!-- Vendor scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- App -->
  <script>
  (function(g){
    const { ethers } = g;

    /* ---------- Contract: address & ABI ---------- */
    const PUPPYRACE_ADDR = "0xC8f946174a5DE63B31d19F36A5180aCbCD401B50"; // PuppyRace
    const ABI = [
      "function getbt() view returns(uint8)",
      "function myPuppy(address) view returns(uint8)",
      "function getmypuppy(address) view returns(uint8)",
      "function getreward() view returns(uint256)",
      "function jack() view returns(uint256)",
      "function Race(uint _ticket) external",
      "function winner(uint) view returns(address)",
      "event lost(uint256 amount, uint256 myPower)",
      "event Bonus(address indexed user, uint256 amount, uint256 reward)",
      "event RewardGiven(address indexed user, uint256 amount, uint256 myPower)"
    ];

    /* ---------- RPC fallback (read) ---------- */
    const OPBNB_RPCS = [
      "https://opbnb-mainnet-rpc.bnbchain.org",
      "https://opbnb-rpc.publicnode.com",
      "https://opbnb.blockpi.network/v1/rpc/public",
      "https://1rpc.io/opbnb"
    ];
    let __readProvider=null, __raceRead=null;

    async function pickHealthyRpc(timeoutMs=4000){
      for(const url of OPBNB_RPCS){
        try{
          const p = new ethers.providers.StaticJsonRpcProvider({url, timeout:timeoutMs}, {chainId:204, name:"opbnb"});
          await Promise.race([p.getBlockNumber(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), timeoutMs))]);
          return p;
        }catch{}
      }
      throw new Error("No healthy opBNB RPC found");
    }
    async function getRead(){
      if(__readProvider && __raceRead) return {provider:__readProvider, race:__raceRead};
      __readProvider = await pickHealthyRpc();
      __raceRead = new ethers.Contract(PUPPYRACE_ADDR, ABI, __readProvider);
      return {provider:__readProvider, race:__raceRead};
    }

    /* ---------- Wallet (write) ---------- */
    let signer=null, raceWrite=null;

    async function ensureOpBNB(userProvider){
      const net = await userProvider.getNetwork();
      if (Number(net.chainId) === 204) return;
      try{
        await g.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0xCC" }] });
      }catch{
        await g.ethereum.request({
          method:"wallet_addEthereumChain",
          params:[{
            chainId:"0xCC",
            rpcUrls:["https://opbnb-mainnet-rpc.bnbchain.org"],
            chainName:"opBNB",
            nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
            blockExplorerUrls:["https://opbnbscan.com"]
          }]
        });
      }
    }

    async function connectWallet(){
      if(!g.ethereum){ alert("Please install a wallet (MetaMask/Rabby)."); return null; }
      const provider = new ethers.providers.Web3Provider(g.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      await ensureOpBNB(provider);
      signer = provider.getSigner();
      raceWrite = new ethers.Contract(PUPPYRACE_ADDR, ABI, signer);
      log("üîå Connected: " + await signer.getAddress());
      await renderMyPuppy();
      return true;
    }

    /* ---------- Helpers ---------- */
    function log(msg){
      const box = document.getElementById("log");
      box.innerHTML = `<div>${new Date().toLocaleTimeString()} ${msg}</div>` + box.innerHTML;
    }
    function safeNum(bn){
      try{
        const n = ethers.BigNumber.isBigNumber(bn) ? bn.toNumber() : Number(bn);
        return Number.isFinite(n) ? n : null;
      }catch{ return null; }
    }
    function fmtGP(bn, decimals=2){
      const n = safeNum(bn);
      return n === null ? (ethers.BigNumber.isBigNumber(bn)? bn.toString() : String(bn)) : n.toFixed(decimals);
    }

    /* ---------- Renders ---------- */
    async function renderStatus(){
      try{
        const { race } = await getRead();
        const reward = await race.getreward();
        document.getElementById("jackpotValue").textContent = fmtGP(reward);

        // Split prizes (1~8). If BN too large, fall back to integer division strings.
        const n = safeNum(reward);
        if(n !== null){
          const splits = [1,2,3,4,5,6,7,8].map(k=> (n/k).toFixed(2));
          for(let i=1;i<=8;i++) document.getElementById("jackpotValue"+i).textContent = splits[i-1] + " GP";
        }else{
          // Big fallback (no decimals)
          const bn = ethers.BigNumber.from(reward);
          for(let i=1;i<=8;i++){
            const q = bn.div(i).toString();
            document.getElementById("jackpotValue"+i).textContent = q + " GP";
          }
        }
      }catch(e){
        document.getElementById("jackpotValue").textContent = "Unknown";
        for(let i=1;i<=8;i++) document.getElementById("jackpotValue"+i).textContent = "‚Äî";
        log("‚ö†Ô∏è Failed to load jackpot.");
      }
    }

    async function renderMyPuppy(){
      try{
        const addr = signer ? await signer.getAddress() : null;
        if(!addr){ document.getElementById("myBreed").textContent = "‚Äî"; return; }
        const { race } = await getRead();
        const breed = await race.getmypuppy(addr);
        document.getElementById("myBreed").textContent = ethers.BigNumber.isBigNumber(breed) ? breed.toString() : String(breed);
        document.getElementById("myPuppyImg").src = `/images/puppy/${Number(breed)}.png`;
      }catch(e){
        document.getElementById("myBreed").textContent = "‚Äî";
        log("‚ö†Ô∏è Failed to load my puppy.");
      }
    }

    async function renderWinnerList(){
      const box = document.getElementById("winnerList");
      box.textContent = "Loading‚Ä¶";
      try{
        const { race } = await getRead();
        const items = [];
        for(let i=0;i<5;i++){
          try{
            const addr = await race.winner(i);
            items.push(`<div>${addr.slice(0,8)}‚Ä¶${addr.slice(-4)}</div>`);
          }catch{ break; }
        }
        box.innerHTML = items.length ? items.join("") : "<span class='mini'>Not yet</span>";
      }catch{
        box.innerHTML = "<span class='text-warning'>Failed to load winners</span>";
      }
    }

    /* ---------- Race ---------- */
    const dogFrames = [
      "/images/puppy/race/0.png",
      "/images/puppy/race/1.png",
      "/images/puppy/race/2.png",
      "/images/puppy/race/3.png",
      "/images/puppy/race/4.png"
    ];

    async function showDogFrameAnimationBig(){
      const overlay = document.getElementById("raceAnimOverlay");
      const img = document.getElementById("animDogBig");
      overlay.style.display = "flex";
      let frame = 0;
      img.src = dogFrames[0];
      try{
        const w = document.getElementById("whistleSound");
        const b = document.getElementById("barkSound");
        w.currentTime=0; w.play().catch(()=>{});
        setTimeout(()=>{ b.currentTime=0; b.play().catch(()=>{}); }, 350);
      }catch{}
      await new Promise((resolve)=>{
        const itv = setInterval(()=>{
          frame++; img.src = dogFrames[frame % dogFrames.length];
          if(frame >= dogFrames.length - 1){
            clearInterval(itv);
            setTimeout(()=>{ overlay.style.display="none"; resolve(); }, 300);
          }
        }, 180);
      });
    }

    async function runRace(){
      if(!raceWrite) await connectWallet();
      const ticket = Number(document.getElementById("betAmount").value);
      if(!Number.isFinite(ticket) || ticket<=0){ alert("Enter a valid ticket count."); return; }

      document.getElementById("raceRank").textContent = "-";
      document.getElementById("rewardAmount").textContent = "0";
      document.getElementById("bonusAmount").textContent  = "0";
      document.getElementById("log").innerHTML = "";

      try{
        log("‚è≥ Sending transaction‚Ä¶");
        const tx = await raceWrite.Race(ticket);
        log("Tx: " + tx.hash);
        const receipt = await tx.wait();
        log("‚úÖ Confirmed: " + tx.hash);

        await showDogFrameAnimationBig();

        const iface = new ethers.utils.Interface(ABI);
        let found = false;
        for(const lg of receipt.logs){
          try{
            const parsed = iface.parseLog(lg);
            const { name, args } = parsed;
            if(name === "RewardGiven"){
              found = true;
              const amount = fmtGP(args.amount);
              const rank = args.myPower?.toString?.() ?? String(args.myPower);
              document.getElementById("raceRank").textContent = rank;
              document.getElementById("rewardAmount").textContent = amount;
              log(`üéâ Reward: ${amount} GP (rank ${rank})`);
            }
            if(name === "Bonus"){
              const b = fmtGP(args.amount);
              document.getElementById("bonusAmount").textContent = b;
              log(`üéÅ Bonus: ${b} GP (stat ${args.reward})`);
            }
            if(name === "lost"){
              found = true;
              const rank = args.myPower?.toString?.() ?? String(args.myPower);
              document.getElementById("raceRank").textContent = rank;
              log(`üò¢ Defeat! GP burned (rank ${rank})`);
            }
          }catch{}
        }
        if(!found) log("No result events found.");

        await renderStatus();
        await renderWinnerList();
        await renderMyPuppy();
      }catch(err){
        let msg = err?.message || "Race failed.";
        if (msg.includes("No Puppy")) msg = "No Puppy!";
        if (msg.includes("Not enough game points")) msg = "Not enough GP!";
        if (msg.includes("The amount is too large")) msg = "Jackpot not enough!";
        log("‚ùå " + msg);
        alert(msg);
      }
    }

    /* ---------- Bindings ---------- */
    document.getElementById("btnConnect").addEventListener("click", connectWallet);
    document.getElementById("btnRefresh").addEventListener("click", async()=>{
      await renderStatus(); await renderMyPuppy(); await renderWinnerList();
    });
    document.getElementById("btnRace").addEventListener("click", runRace);

    /* ---------- Boot ---------- */
    g.addEventListener("load", async ()=>{
      try{
        await renderStatus();
        await renderMyPuppy();
        await renderWinnerList();
        setInterval(renderStatus, 3000);
      }catch(e){ log("‚ö†Ô∏è Initial load failed."); }
    });

    // Optional expose
    g.PRace = { connectWallet, runRace };
  })(window);
  </script>
</body>
</html>
